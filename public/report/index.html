<html>
  <head>
    <title>Report</title>
    <script src="heatmap.js"></script>
  </head>
  <body>
    <pre id="report"></pre>
    <div id="heatmap"></div>

    <script>
      (async () => {
        const events = await fetch(
          "http://localhost:3000/events/d6fd4a00-2fc7-4bbd-a6b0-f0d2867dea0c",
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          }
        ).then((res) => res.json());

        const eventsByPath = {};

        events.forEach((event) => {
          if (!event.path) return;
          if (!eventsByPath[event.type]) eventsByPath[event.type] = {};
          if (!eventsByPath[event.type][event.name])
            eventsByPath[event.type][event.name] = {};
          eventsByPath[event.type][event.name][event.path] =
            (eventsByPath[event.type][event.name][event.path] ?? 0) + 1;
        });

        document.getElementById("report").innerHTML = JSON.stringify(
          eventsByPath,
          null,
          2
        );

        const mouseEventsData = {};

        const mouseEvents = events.filter((e) =>
          ["mouse", "drag"].includes(e.type)
        );

        mouseEvents.forEach((me) => {
          const key = `${me.properties.clientX}-${me.properties.clientY}`;
          mouseEventsData[key] = (mouseEventsData[key] ?? 0) + 1;
        });

        const heatmapData = Object.keys(mouseEventsData).map((key) => {
          const [x, y] = key.split("-");
          return { x: +x, y: +y, value: mouseEventsData[key] };
        });

        const heatmapContainer = document.getElementById("heatmap");
        const uiEvent = events.find((e) => e.type === "ui");
        console.log(uiEvent);
        Object.assign(heatmapContainer.style, {
          width: `${uiEvent.properties.screen.width}px`,
          height: `${uiEvent.properties.screen.height}px`,
          "background-image": `url(${uiEvent.properties.screenshot})`,
          "background-size": "contain",
        });

        const heatmap = window.h337.create({
          container: heatmapContainer,
        });

        heatmap.setData({
          min: Math.min(...heatmapData.map((d) => d.value)),
          max: Math.max(...heatmapData.map((d) => d.value)),
          data: heatmapData,
        });
      })();
    </script>
  </body>
</html>
